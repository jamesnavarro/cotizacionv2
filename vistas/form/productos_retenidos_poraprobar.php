<?php  $sql21 = "SELECT * FROM cotizacion where id_cot=".$_GET['cot'];            $fila21 =mysqli_fetch_array(mysqli_query($conexion,$sql21));             $numero_cotizacion= $fila21["numero_cotizacion"];            $id= $fila21["id_cot"];            $tipo= $fila21["tipo"];            $obra= $fila21["obra"];            $ubicacion= $fila21["ubicacion"];   $pago= $fila21["pago"];            $linea= $fila21["linea"];            $orden_p= $fila21["orden"]; $version= $fila21["version"];            $estado= $fila21["estado"];            $id_cliente= $fila21["id_cliente"];            $asesor= $fila21["registrado"];            $responsable= $fila21["responsable"];             $tel_responsable= $fila21["tel_responsable"];              $ciudad= $fila21["municipio"].' - '.$fila21["ciudad"];              $mu= $fila21["municipio"];              $ci= $fila21["ciudad"];$grabado= $fila21["grabado"];              $costo_total= $fila21["costo_total"];              $costo_instalacion= $fila21["costo_instalacion"];              $descuento= $fila21["descuento"];              $fecha= $fila21["fecha_reg_c"];$tipo= $fila21["tipo"];$pre= $fila21["presupuesto"];              if($tipo=='Empresarial'){                       $con= "SELECT * FROM `sis_empresa` where id_empresa=".$id_cliente."";    $res=  mysqli_query($conexion,$con);    while($f=  mysqli_fetch_array($res)){       $doc=$f['nit_emp'];    $direccion=$f['direccionr_emp'];    $telefono_cli=$f['tel_oficina_emp'];    $contacto=$f['nombre_emp'];    $tel_cont=$f['celular_emp'];    $email=$f['email1_emp'];    $propietario =$f['propietario_emp'];    $pvi=$f['pvi'];$pal=$f['pal'];$pac=$f['pac'];    }              }else{                      $con= "SELECT * FROM `sis_contacto` where id_contacto=".$id_cliente."";    $res=  mysqli_query($conexion,$con);    while($f=  mysqli_fetch_array($res)){    $doc=$f['cedula_cont'];    $direccion=$f['direccionf'];    $telefono_cli=$f['tel_oficina'];    $contacto=$f['nombre_cont'].' '.$f['apellido_cont'];    $tel_cont=$f['celular'];    $email=$f['email1'];    $propietario ='';    $pvi=$f['pvi'];    $pal=$f['pal'];    $pac=$f['pac'];    }              }?>                             <div class="row-fluid">                        <!-- START Form Wizard -->                      <!-- START Widget Collapse -->                           <section class="body">                                <div class="body-inner">                        <div class="span12 widget dark stacked">                        <header>                                <h4 class="title">Detalle de Orden de Produccion No. <?php echo $_GET['op'] ?>                                    <br>Cliente: <?php echo $contacto; ?>                                    <br>Obra: <?php echo $obra; ?>                                    <br>Telefonos: <?php echo $telefono_cli; ?>                                </h4>                                                                                     </header>                             <section id="collapse1" class="body collapse in">                                <div class="body-inner">                                                                               <!-- Normal Tabs -->                                                        <div class="tabbable" style="margin-bottom: 25px;">                                                            <div class="tab-content">                                    <div class="tab-pane <?php if(!isset($_GET['ped'])){echo 'active';} ?>" id="tab3">                                         <!-- START Row -->                    <div class="row-fluid">                        <!-- START Datatable 2 -->                        <div class="span12 widget lime">                                                        <section class="body">                                <div class="body-inner no-padding">                                                                        <form name="buscarA" action="<?php echo '../vistas/?id=pt_detalles&cot='.$_GET['cot'].'&cli='.$_GET['cli'].'&op='.$_GET['op'].'&prefact' ?>" method="post" enctype="multipart/form-data"><?php//Esta es la cadena limit que anexaremos a nuestra consulta $request=mysqli_query($conexion,"SELECT *, (a.producto) as prod, (e.codigo) as co, (e.id_op) as pedido, (c.porcentaje) as p1 FROM producto a, cotizaciones c, orden_detalle e, procesos_activos f where e.parte_otro='0' and e.codigo=".$_GET['op']." and f.id_orden_d=e.id_orden_d and e.id_producto=a.id_p  and c.id_referencia=a.id_p group by f.id_orden_d ");     if($request){//    echo'<hr>';             $table = '<table class="table table-bordered table-striped table-hover" id="tabla">';             $table = $table.'<thead >';              $table = $table.'<tr bgcolor="#D1EEF0">';              $table = $table.'<th width="3%">'.'O.P'.'</th>';                     $table = $table.'<th width="3%">'.'Ped'.'</th>';                $table = $table.'<th width="3%">'.'Codigo'.'</th>';                $table = $table.'<th width="5%">'.'Referencia'.'</th>';               $table = $table.'<th width="20%">'.'Descripcion del Producto'.'</th>';                         $table = $table.'<th width="7%">'.'Color Vid.'.'</th>';                           $table = $table.'<th width="4%">'.'Esp Vid (mm)'.'</th>';                          $table = $table.'<th  width="4%">'.'Cant Ordenadas'.'</th>';               $table = $table.'<th  width="4%">'.'Cant Pendientes'.'</th>';               $table = $table.'<th width="4%">'.'Cant Terminadas'.'</th>';                              $table = $table.'<th width="4%">'.'Cant Aprobadas'.'</th>';               $table = $table.'<th width="4%">'.'Cant sin Aprobar'.'</th>';                $table = $table.'<th width="4%">'.'Cant a Aprobar'.'</th>';               $table = $table.'<th width="4%">'.'Valor'.'</th>';               $table = $table.'<th width="4%">'.'Valor Total'.'</th>';               $table = $table.'<th width="4%">'.'Ubicacion'.'</th>';               $table = $table.'<th  width="4%">'.'Seleccionar'.'</th>';              $table = $table.'</tr>';              $table = $table.'</thead>';	        	//Por cada resultado pintamos una linea        $total2=0;        $ta2 =0;        $cont =0;                $tacot =0;	while($row=mysqli_fetch_array($request))	{                          if($row["linea_cot"]=='Aluminio'){                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Aluminio'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }else{                if($row["linea_cot"]=='Vidrio'){                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Vidrio'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }else{                if($row["linea_cot"]=='Fachada'){                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Fachada'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }else{                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Acero'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }                }                 }                    if($row["linea_cot"]=='Vidrio'){$d1 = 'Per:'.$row["per"].', Boq:'.$row["boq"];}else{$d1 = $row["color_ta"];}                      $cont = $cont + 1;            $suma2 = $row["valor_c"];            $a = $suma2 / $mult;            $tk = ($row["precio_adicional"] + $row["precio_material"]) * $row["cantidad_c"];            $b = $a;            $descpor = $b *  $row["desc"]/100;            $b = $b + $descpor;             $pu = ($b/$row["cantidad_c"]) + $tk;            $ptt = ($pu) * $row["cantidad_c"];            $tacot = $tacot + $ptt;                        if($editar_cot=='Habilitado'){$up = '&ord='.$row["id_cotizacion"].'';}else{$up = '';}            if($eliminar_cot=='Habilitado'){$del = '&del='.$row["id_cotizacion"].'';}else{$del = '';}            $pr = $row["cantidad_c"]-$row["cant_restante"];                         $sql211 = "SELECT * FROM orden_detalle where relacionado=".$row["id_cotizacion"]." and id_orden_d=".$row["id_orden_d"]." ";            $fila211 =mysqli_fetch_array(mysqli_query($conexion,$sql211));            $m1= $fila211["medida1"];            $m2= $fila211["medida2"];            $c= $fila211["cant_ordenada"];            $x= $fila211["estado_op"];            if($c==""){                $in = '';                $boton = '<button type="submit"><img src="../imagenes/guardar.jpg"></button>';                $an = $row['ancho_c'];                $al= $row['alto_c'];            }else{                $in = 'readonly';                $boton = '<img src="../imagenes/ok.png">';                $an = $m1;                $al= $m2;            }                    $sap = "SELECT sum(cantidad_aprobada) FROM pa_aprobados where barra=".$row["barra"]." ";                $fiap =mysqli_fetch_array(mysqli_query($conexion,$sap));                $cp= $fiap["sum(cantidad_aprobada)"];                if($cp==''){                    $ctt = $row['cant_ordenada'] - 0;                }else{                    $ctt = $row['cant_ordenada'] - $cp;                }      if($ctt!=0){                                $cpo = $row['cantidad_c'] - $row['cant_ordenada'];                $cpoap = $row['cant_ordenada'] - $ctt;                $ta2 = $ta2 + ($pu * $ctt);            $table = $table.'<tr><td width="3%">'.$row["co"].'</a></td>                        <td width="3%">'.$row["orden"].'</a></td><td width="3%">'.$row["barra"].'</a></td>                        <td width="5%">'.$row['referencia_p'].'</font></td>                        <td width="25%">'.$row['prod'].'</a></td>                        <td width="7%">'.$row['medida1'].'x'.$row['medida2'].'</a></td>                                               <td width="4%">'.$row["espesor_v"].'</td>                        <td  width="4%">'.$row['cantidad_c'].'</td>                            <td  width="4%">'.$cpo.'</td>                                                   <td width="4%">'.$row['cant_ordenada'].'</td>'                    . '<td width="4%">'.$cpoap.'</td> <td width="4%">'.$ctt.'</td><input type="hidden" name="aprob2'.$cont.'" style="width:60px" value="'.$ctt.'">'                    . '<td width="4%"><input type="number" name="aprob'.$cont.'" style="width:60px" value="'.$ctt.'"></td>'                    . '<td width="4%">'.number_format($pu).'</td>'                    . '<td width="4%">'.number_format($pu * $ctt).'</td>                    <td width="4%">'.$row['ubicacion'].'</td>                        <td  width="4%"><input type="checkbox" name="valor'.$cont.'" checked value="'.$row["barra"].'" ></td>                                                </tr>';         }		} 	$table = $table.'</table>';        	echo $table;         echo '<div align="right"> + ________________________________________</div>';   echo '<div align="right"><FONT color="red"><h5>TOTAL: $'.number_format($ta2).'</h5></FONT></div>';} ?>                                            <table>                <tr>                    <td><label><i>Total de Productos terminados: </i></label>                        <input type="text" name="cant"  style="width:20px;height:20px;" readonly value="<?php echo $cont; ?>">                        <?php if($crear_ret=='Habilitado'){   ?><input type="submit" name="buscar" value="Aprobar Parcial" class="alt_btn"><?php  }  ?></td>                </tr>                            </table>                                 </form></div>                            </section>                                                    </div>                        <!--/ END Datatable 2 -->                    </div>                    <!--/ END Row -->                                    </div>                                                            </div>                            </div><!--/ Normal Tabs -->                                </div>                            </section>                                                            <section id="collapse1" class="body collapse in">                                <div class="body-inner">                                                                               <!-- Normal Tabs -->                                                        <div class="tabbable" style="margin-bottom: 25px;">                                                            <div class="tab-content">                                    <div class="tab-pane <?php if(!isset($_GET['ped'])){echo 'active';} ?>" id="tab3">                                         <!-- START Row -->                    <div class="row-fluid">                        <!-- START Datatable 2 -->                        <div class="span12 widget lime">                                                        <section class="body">                                <div class="body-inner no-padding">                                                                        <form name="buscarA" action="<?php echo '../vistas/?id=pt_detalles&cot='.$_GET['cot'].'&cli='.$_GET['cli'].'&op='.$_GET['op'].'&fact' ?>" method="post" enctype="multipart/form-data"><?php//Esta es la cadena limit que anexaremos a nuestra consulta $request=mysqli_query($conexion,"SELECT *, (a.producto) as prod, (e.codigo) as co, (e.id_op) as pedido, (c.porcentaje) as p1 FROM producto a, cotizaciones c, orden_detalle e, procesos_activos f, pa_aprobados g where g.estado_apro='Preaprobado' and f.barra=g.barra and  e.codigo=".$_GET['op']." and f.id_orden_d=e.id_orden_d and e.id_producto=a.id_p and f.estado='Terminado' and c.id_referencia=a.id_p group by g.id_apro ");     if($request){//    echo'<hr>';             $table = '<table class="table table-bordered table-striped table-hover" id="tabla2">';             $table = $table.'<thead >';              $table = $table.'<tr bgcolor="#D1EEF0">';              $table = $table.'<th width="3%">'.'O.P'.'</th>';                     $table = $table.'<th width="3%">'.'Ped'.'</th>';                $table = $table.'<th width="3%">'.'Codigo'.'</th>';                $table = $table.'<th width="5%">'.'Referencia'.'</th>';               $table = $table.'<th width="20%">'.'Descripcion del Producto'.'</th>';                         $table = $table.'<th width="7%">'.'Color Vid.'.'</th>';                           $table = $table.'<th width="4%">'.'Esp Vid (mm)'.'</th>';                                         $table = $table.'<th width="4%">'.'Cant Aprobadas'.'</th>';               $table = $table.'<th width="4%">'.'Valor'.'</th>';               $table = $table.'<th width="4%">'.'Valor Total'.'</th>';               $table = $table.'<th width="4%">'.'Ubicacion'.'</th>';               $table = $table.'<th width="4%">'.'Aprobado el'.'</th>';               $table = $table.'<th  width="4%">'.'Check'.'</th>';              $table = $table.'</tr>';              $table = $table.'</thead>';	        	//Por cada resultado pintamos una linea        $total2=0;        $ta2 =0;        $cont =0;                $tacot =0;	while($row=mysqli_fetch_array($request))	{                          if($row["linea_cot"]=='Aluminio'){                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Aluminio'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }else{                if($row["linea_cot"]=='Vidrio'){                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Vidrio'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }else{                if($row["linea_cot"]=='Fachada'){                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Fachada'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }else{                $s3 = "SELECT (".$row["p1"].") as p FROM porcentajes where area_por='Acero'";                $fi3 =mysqli_fetch_array(mysqli_query($conexion,$s3));                $mult= $fi3["p"]/100;                }                }                 }                    if($row["linea_cot"]=='Vidrio'){$d1 = 'Per:'.$row["per"].', Boq:'.$row["boq"];}else{$d1 = $row["color_ta"];}                      $cont = $cont + 1;            $suma2 = $row["valor_c"];            $a = $suma2 / $mult;            $tk = ($row["precio_adicional"] + $row["precio_material"]) * $row["cantidad_c"];            $b = $a;            $descpor = $b *  $row["desc"]/100;            $b = $b + $descpor;             $pu = ($b/$row["cantidad_c"]) + $tk;            $ptt = ($pu) * $row["cantidad_c"];            $tacot = $tacot + $ptt;                        if($editar_cot=='Habilitado'){$up = '&ord='.$row["id_cotizacion"].'';}else{$up = '';}            if($eliminar_cot=='Habilitado'){$del = '&del='.$row["id_cotizacion"].'';}else{$del = '';}            $pr = $row["cantidad_c"]-$row["cant_restante"];                         $sql211 = "SELECT * FROM orden_detalle where relacionado=".$row["id_cotizacion"]." and id_orden_d=".$row["id_orden_d"]." ";            $fila211 =mysqli_fetch_array(mysqli_query($conexion,$sql211));            $m1= $fila211["medida1"];            $m2= $fila211["medida2"];            $c= $fila211["cant_ordenada"];            $x= $fila211["estado_op"];            if($c==""){                $in = '';                $boton = '<button type="submit"><img src="../imagenes/guardar.jpg"></button>';                $an = $row['ancho_c'];                $al= $row['alto_c'];            }else{                $in = 'readonly';                $boton = '<img src="../imagenes/ok.png">';                $an = $m1;                $al= $m2;            }                            $res = $row['cant_ordenada'] - $row['cantidad_aprobada'];                $ta2 = $ta2 + ($pu * $row['cantidad_aprobada']);            $table = $table.'<tr><td width="3%">'.$row["co"].'</a></td>                        <td width="3%">'.$row["orden"].'</a></td><td width="3%">'.$row["barra"].'</a></td>                        <td width="5%">'.$row['referencia_p'].'</font></td>                        <td width="25%">'.$row['prod'].'</a></td>                        <td width="7%">'.$row['medida1'].'x'.$row['medida2'].'</a></td>                                               <td width="4%">'.$row["espesor_v"].'</td><td width="4%">'.$row['cantidad_aprobada'].'</td>'                    . '<td width="4%">'.number_format($pu).'</td>'                    . '<td width="4%">'.number_format($pu * $row['cantidad_aprobada']).'</td>                    <td width="4%">'.$row['ubicacion'].'</td> <td width="4%">'.$row['registro'].'</td>                        <td  width="4%"><input type="checkbox" name="valor'.$cont.'" checked value="'.$row["id_apro"].'" ></td>                                                </tr>';               		} 	$table = $table.'</table>';        	echo $table;         echo '<div align="right"> + ________________________________________</div>';   echo '<div align="right"><FONT color="red"><h5>TOTAL: $'.number_format($ta2).'</h5></FONT></div>';} ?>                                            <table>                <tr>                    <td><label><i>Total de Productos terminados: </i></label>                        <input type="text" name="cant"  style="width:20px;height:20px;" readonly value="<?php echo $cont; ?>">                        <?php if($crear_ret=='Habilitado'){   ?><input type="submit" name="buscar" value="Enviar a remision" class="alt_btn"><?php  }  ?></td>                </tr>                            </table>                                 </form></div>                            </section>                                                    </div>                        <!--/ END Datatable 2 -->                    </div>                    <!--/ END Row -->                                    </div>                                                            </div>                            </div><!--/ Normal Tabs -->                                </div>                            </section>                        </div>                    </div> </section></div>     <?php if(isset($_GET['fact'])){     include "../modelo/conexion.php";$sql1 = "SELECT MAX(numero_factura) as id_inc FROM facturas";$fila1 =mysqli_fetch_array(mysqli_query($conexion,$sql1));$factura = $fila1["id_inc"]+1;    if(isset($_POST["cant"]))    {        $n = $_POST["cant"];        $total = 0;        for($x=1; $x<=$n; $x=$x+1){            if(isset($_POST["valor$x"])){                include "../modelo/conexion.php";                                               $insu = "UPDATE `pa_aprobados` SET estado_apro='Remisionar' WHERE  `id_apro`='".$_POST["valor$x"]."'";                        mysqli_query($conexion,$insu);                                                                                echo 'El Items No. :'.$_POST["valor$x"].' ha sido Aprobado por cartera.<br>';                             }                     }             }if($total!=0){$cambio = valorEnLetras($total);         $forma_pago = '30 DIAS';        $meses = '1';        $pago_pendiente = 'Si';                $copagos = 0;        $fecha_reg= date("Y-m-d H:i:s");              	$sql = "INSERT INTO `facturas`(`copagos`,`letras`,`fechai`, `fechaf`,`numero_factura`, `id_cliente`, `forma_pago`, `meses`, `pago_pendiente`, `total`, `fecha_registro`, `detalle`, `descuento`, `tipo_cliente`, `numero_pedido`, `cotizacion`, `registrado_por`, `asesor`)";        $sql.= "VALUES ('".$copagos."','".$cambio."','".$fecha."', '".$fecha_reg."','".$factura."', '".$id_cliente."', '".$forma_pago."', '".$meses."', '".$pago_pendiente."', '".$total."', '".$fecha_reg."', '".$_POST['obs']."', '".$descuento."', '".$tipo."', '".$_GET['ped']."', '".$_GET['cot']."', '".$_SESSION['nombre']."', '".$fila21["registrado"]."')";	mysqli_query($conexion,$sql);}    echo '<script lanquage="javascript">alert("Se ha aprobado los productos y han pasado al modulo de remisiones");location.href="../vistas/?id=pt"</script>'; }if(isset($_GET['prefact'])){     include "../modelo/conexion.php";$sql1 = "SELECT MAX(numero_factura) as id_inc FROM facturas";$fila1 =mysqli_fetch_array(mysqli_query($conexion,$sql1));$factura = $fila1["id_inc"]+1;    if(isset($_POST["cant"]))    {        $n = $_POST["cant"];        $total = 0;        for($x=1; $x<=$n; $x=$x+1){            if(isset($_POST["valor$x"])){                include "../modelo/conexion.php";                                           if($_POST["aprob$x"] > $_POST["aprob2$x"]){                           echo '<script lanquage="javascript">alert("La cantidad a Aprobar es mayor a la cantidad sin aprobar");</script>';                     }else{                                                                                            $sql = "INSERT INTO `pa_aprobados`(`barra`,`cantidad_aprobada`,`estado_apro`, `factura`)";                        $sql.= "VALUES ('".$_POST["valor$x"]."','".$_POST["aprob$x"]."','Preaprobado', '0')";                        mysqli_query($conexion,$sql);                        echo 'El Items No. :'.$_POST["valor$x"].' ha sido PreAprobado por cartera.<br>';                    }                                                                 }                     }             }    echo '<script lanquage="javascript">alert("Se ha PreAprobado los productos");location.href="../vistas/?id=pt_detalles&cot='.$_GET['cot'].'&cli='.$_GET['cli'].'&op='.$_GET['op'].'"</script>'; }